---
title: "Claude Code Dummy Session Strategy - 5時間制限を緩和する実験的アプローチ"
emoji: "🤖"
type: "tech"
topics: ["claude", "claudecode", "ai", "github", "githubactions"]
published: false
---

## はじめに

Claude Code CLIには5時間のローリングウィンドウ制限があります。本記事では、GitHub Actionsを使って定期的にダミーセッションを開始することで、この制限を緩和する実験的手法について解説します。

:::message
**「Dummy Session Strategy」は本記事で使用する造語です。** 公式の手法ではなく、あくまで実験的なアプローチであることをご了承ください。
:::

## 背景: Claude Codeの5時間制限とは

### 5時間ローリングウィンドウの仕組み

Claude Code（Pro/Max プラン）では、以下の制限があります:

- **5時間ローリングウィンドウ**: 最初のメッセージ送信時から5時間
- **複数セッションの同時進行**: ローリング方式で複数セッションが利用可能
- **共有プール**: Claude.ai（Web）、Claude Desktop、Claude Code CLIで同じプールを使用

```
時刻    セッション
────────────────────────────────
10:00   Session A 開始 ━━━━━━━━━━━━━━► 15:00 期限切れ
11:00   Session B 開始 ━━━━━━━━━━━━━━━━► 16:00 期限切れ
12:00   Session C 開始 ━━━━━━━━━━━━━━━━━━► 17:00 期限切れ
```

### 課題

作業開始と同時に5時間カウントが始まるため、長時間作業する場合に制限に達してしまう可能性があります。

## Dummy Session Strategy とは

### コンセプト

作業開始前にGitHub Actionsで定期的に「ダミーセッション」を開始することで、ローリングウィンドウを事前に消費し、実際の作業時には既に新しいセッション枠が利用可能な状態を作り出す手法です。

### 重要な発見: OAuth認証の利用

当初、Anthropic APIキーを使う方法を検討していましたが、これでは**API従量課金プール**を使用してしまい、Subscriptionプールとは別扱いになることが判明しました。

**解決策**: Claude Code OAuth Token (`CLAUDE_CODE_OAUTH_TOKEN`) を使用することで、GitHub ActionsでもSubscriptionプールを利用できます。

## 実装手順

### 1. OAuth Tokenの生成

```bash
claude setup-token
```

出力例:
```
sk-ant-oat01-xxxxxxxxxxxxx...
```

### 2. GitHub Secretsへの登録

```bash
# GitHub CLI を使用
echo "your-oauth-token-here" | gh secret set CLAUDE_CODE_OAUTH_TOKEN
```

または、GitHubのWeb UIから:
1. Settings → Secrets and variables → Actions
2. New repository secret
3. Name: `CLAUDE_CODE_OAUTH_TOKEN`
4. Secret: 上記で生成したトークン

### 3. GitHub Actions ワークフローの作成

`.github/workflows/claude-keepalive.yml`:

```yaml
name: Claude Session Keep-Alive

# 1時間ごとに実行してSubscriptionの5時間ローリングウィンドウを活用
on:
  schedule:
    # 毎時0分に実行 (UTC)
    - cron: '0 * * * *'

  # 手動実行も可能
  workflow_dispatch:

jobs:
  keep-session-alive:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Send dummy message to Claude (OAuth)
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          mode: agent
          direct_prompt: "Hi"

      - name: Log execution
        run: |
          echo "Dummy session started at $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "Next execution in 1 hour"
          echo "Using Pro/Max Subscription OAuth token"
```

### 4. 動作テスト

```bash
# 手動実行
gh workflow run "Claude Session Keep-Alive"

# 実行履歴確認
gh run list --workflow="Claude Session Keep-Alive" --limit 5
```

## 仕組みの詳細

### API認証 vs OAuth認証

| 認証方法 | 使用プール | 課金方式 | GitHub Actionsでの利用 |
|---------|-----------|---------|----------------------|
| API Key (`ANTHROPIC_API_KEY`) | API従量課金 | トークン単位 | 別プール（Subscriptionと無関係） |
| OAuth Token (`CLAUDE_CODE_OAUTH_TOKEN`) | Subscription | 月額固定 | **Subscriptionプールを使用** ✅ |

### ローリングウィンドウの活用例

```
時刻    アクション                           効果
────────────────────────────────────────────────────────────
6:00    GitHub Actions実行 → Session A開始
7:00    GitHub Actions実行 → Session B開始
8:00    GitHub Actions実行 → Session C開始
9:00    あなたの作業開始 → Session D開始      ← 複数セッション利用可能
11:00   Session A期限切れ → 即座に再利用可能
12:00   Session B期限切れ → 即座に再利用可能
13:00   Session C期限切れ → 即座に再利用可能
```

## 注意事項

### 1. コストについて

- **トークン消費**: 1回の実行で約10トークン
- **月間消費**: 約7,200トークン（24回/日 × 30日）
- **影響**: Subscriptionプランの使用量にカウントされます

### 2. 効果の確認方法

翌朝、以下で確認:

```bash
# Claude Code CLI内で
/cost
```

または Claude.ai の Settings → Usage で「Current session」の開始時刻をチェック。

**期待される結果**:
- ローカルで何も操作していないのに既にセッションが開始されている
- または、使用可能なセッション枠が複数ある状態

### 3. 制限事項

:::message alert
この方法は実験的なアプローチです。以下の点に注意してください:

- Anthropicの利用規約に準拠しているか不明
- 将来的に動作が変更される可能性あり
- 効果が確認できない可能性もあり
:::

### 4. トラブルシューティング

#### ワークフローが失敗する場合

```bash
# ログ確認
gh run view --log

# よくあるエラー
# - "Tag mode cannot handle workflow_dispatch events"
#   → mode: agent に変更

# - "Authentication failed"
#   → OAuth Tokenの再生成
```

## まとめ

本記事では、Claude Code CLIの5時間制限を緩和するための実験的手法「Dummy Session Strategy」を紹介しました。

**ポイント**:
- OAuth認証を使うことでSubscriptionプールを利用
- GitHub Actionsで1時間ごとにダミーセッション開始
- ローリングウィンドウを事前に消費することで実作業時の制限緩和を狙う

**今後の検証**:
- 実際の効果測定
- 長期運用での影響確認
- コスト対効果の評価

この手法が皆さんの開発効率向上に役立てば幸いです。効果測定の結果は追記予定です。

## 参考資料

- [Claude Code GitHub Actions - Claude Docs](https://docs.claude.com/en/docs/claude-code/github-actions)
- [anthropics/claude-code-action - GitHub](https://github.com/anthropics/claude-code-action)
- [Claude Code の利用制限について](https://support.claude.com/en/articles/9797557-usage-limit-best-practices)
